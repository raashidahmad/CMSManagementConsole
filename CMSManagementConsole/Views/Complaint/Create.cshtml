@model CMSManagementConsole.Models.NewComplaint

@{
    ViewBag.Title = "Create";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="view-content">

    <div class="row">
        <div class="col-md-12">
            <ul class="nav nav-tabs">

                <li>
                    @Html.ActionLink("Complaint List", "Index", null, null)
                </li>
                <li class="active"><a href="#">New Complaint</a></li>
            </ul>
        </div>
    </div>

    <div class="row margin-top">
        @using (Html.BeginForm())
            {
            @Html.AntiForgeryToken()

            <div class="form-horizontal">
                @Html.ValidationSummary(true, "", new { @class = "text-danger" })

                <div class="form-group">
                    @Html.LabelFor(model => model.CategoryId, htmlAttributes: new { @class = "control-label col-md-2" })
                    <div class="col-md-10">
                        @Html.DropDownList("CategoryId", null, htmlAttributes: new { @class = "form-control" })
                        @Html.ValidationMessageFor(model => model.CategoryId, "", new { @class = "text-danger" })
                    </div>
                </div>

                <div class="form-group">
                    @Html.LabelFor(model => model.Description, htmlAttributes: new { @class = "control-label col-md-2" })
                    <div class="col-md-10">
                        @Html.EditorFor(model => model.Description, new { htmlAttributes = new { @class = "form-control" } })
                        @Html.ValidationMessageFor(model => model.Description, "", new { @class = "text-danger" })
                    </div>
                </div>

                <div class="form-group">
                    <div class="col-md-10 typeahead">
                        @Html.LabelFor(model => model.ComplainantId, htmlAttributes: new { @class = "control-label col-md-2" })
                        <input type="text" id="typeahead" class="typeahead form-control" placeholder="" />
                        @Html.ValidationMessageFor(model => model.ComplainantId, "", new { @class = "text-danger" })
                    </div>
                </div>

                <div id="user-info" class="form-group-sm col-md-offset-2" style="display: none;">
                    <table id="tbl-info" class="table table-striped">
                    </table>
                </div>

                <div class="form-group">
                    <div class="col-md-offset-2 col-md-10">
                        <input type="submit" value="Create" class="btn btn-primary" />
                    </div>
                </div>
            </div>
            }
    </div>
</div>

@section Scripts
    {
    @Scripts.Render("~/Scripts/typeahead.js");
    @Scripts.Render("~/Scripts/Custom/load-categories.js");

    <script>
        var complainantsUrl = '@Url.Action("GetComplainants", "complaint")';
        var categoriesUrl = '@Url.Action("PopulateCategories", "complaint")';
        var complainants = {};
        var complainantsList = {};
        var complainantId = 0;

        $(function () {

            //Get Complainants List
            $.ajax({
                url: complainantsUrl,
                dataType: 'json',
                type: "GET",
                contentType: 'application/json; charset=utf-8',
                beforeSend: function () {
                },
                complete: function () {
                },
                success: function (response) {
                    if (response.length > 0) {
                        complainants = response;

                        //Setting up typeahead
                        complainantsList = new Bloodhound({
                            datumTokenizer: Bloodhound.tokenizers.obj.whitespace("NIC"),
                            queryTokenizer: Bloodhound.tokenizers.whitespace,
                            local: complainants
                        });
                        complainantsList.initialize();

                        $("#typeahead").typeahead({
                            hint: true,
                            highlight: true,
                            minLength: 2
                        },
                        {
                            name: "result",
                            displayKey: "NIC",
                            source: complainantsList.ttAdapter()
                        }).bind("typeahead:selected", function (obj, datum, name) {
                            showSelectedUser(datum.Id, datum.FullName, datum.NIC);
                        });
                    }
                },
                error: function (err) {
                }
            });

            $('#tbl-info').on('click', '.btn-danger', function (e) {
                //var tr = $(e.currentTarget).closest('tr');
                //tr.remove();
                $('#tbl-info').empty();
                $('#user-info').hide();
            });

        });
        
        //List the selected user
        function showSelectedUser(id, fullName, nic) {
            var trArr = Array();
            trArr[0] = '<tr><th>Id</th><th>Full Name</th><th>NIC</th><th>Remove</th></tr>';
            trArr[1] = '<tr><td>' + id + '</td><td>' + fullName + '</td><td>' + nic + '</td><td><button type="button" class="btn btn-danger"><i class="fa fa-trash"></i></button></td></tr>';
            //$('#tbl-info tr:last').after(tr);
            var trs = trArr.join('');
            $('#tbl-info').append(trs);
            $('#user-info').show();
            $('#typeahead').typeahead('val', null);
        }

    </script>
    }
